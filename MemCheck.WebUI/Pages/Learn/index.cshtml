@page
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model LearnViewModel
@section head {
    <link href="@Url.Content("~/css/learn.css")" rel="stylesheet" type="text/css" asp-append-version="true" />
    <link href="@Url.Content("~/css/toolbarbutton.css")" rel="stylesheet" type="text/css" asp-append-version="true" />
    <link href="@Url.Content("~/css/rating.css")" rel="stylesheet" type="text/css" asp-append-version="true" />
    <link href="@Url.Content("~/css/tagbutton.css")" rel="stylesheet" type="text/css" asp-append-version="true" />
    <link href="@Url.Content("~/css/markdownrendering.css")" rel="stylesheet" type="text/css" asp-append-version="true" />
    <link href="@Url.Content("~/css/imageincard.css")" rel="stylesheet" type="text/css" asp-append-version="true" />
}
@section scripts {
    <script src="~/lib/vant/vant.js" asp-append-version="true"></script>
    <script src="~/js/CardRating.js" asp-append-version="true"></script>
    <script src="~/js/big-size-image.js" asp-append-version="true"></script>
    <script src="~/js/TagButton.js" asp-append-version="true"></script>
    <script type="module" src="~/js/Learn/Learn.js" asp-append-version="true"></script>
}
@{
    ViewData["Title"] = @Localizer["PageTitle"];
}
<input type="text" asp-for="LearnMode" id="LearnModeInput" hidden="hidden" />

<div id="LearnMainDiv" class="page-responsive-padding" v-cloak>
    <div id="WaitingOrLoading" v-if="!mountFinished || loading">
        <p class="wait-message">@Localizer["PleaseWaitForMount"]</p>
    </div>
    <div id="FilteringDisplayDiv" v-if="mountFinished && filteringDisplay && !userQuitAttemptDisplay" class="learn-filtering-display-div">
        <div id="TagFilteringDiv">
            <h1>@Localizer["FilterThisLearningSession"]</h1>
            @Localizer["ExcludedTags"]
            <select v-model="selectedExcludedTagToAdd"><option v-for="tag in activeDeck.tags" v-bind:value="tag">{{tag.tagName}}</option></select>
            <span id="AddExcludedTagButton" v-if="CanAddSelectedExcludedTag()">
                <button class="btn-success toolbar-button" @@click="addExcludedTag">+</button>
            </span>
            <button class="tag" v-for="(tag,index) in selectedExcludedTags" @@click="removeExcludedTag(index)"><span aria-hidden="true">{{tag.tagName}} &times;</span></button>
        </div>
        <button class="btn btn-info toolbar-button learn-filtering-ok-button" @@click="closeFilteringMode()">@Localizer["Ok"]</button>
    </div>
    <div id="NormalOrFullScreenMode" v-if="mountFinished && !filteringDisplay && !userQuitAttemptDisplay">
        <div id="FullScreenImage" v-if="currentFullScreenImage">
            <big-size-image v-bind:image="currentFullScreenImage" v-bind:labels="bigSizeImageLabels" v-on:close="closeFullScreenImage()" />
        </div>
        <div id="NormalMode" v-else>
            <div id="Deck choice and global info" class="table-responsive" v-if="!singleDeckDisplay">
                <table class="table table-responsive" width="100%">
                    <tbody>
                        <tr id="Deck choice">
                            <th>@Localizer["Deck"]</th>
                            <td>
                                <select v-model="activeDeck"><option v-for="deck in userDecks" v-bind:value="deck">{{deck.description}}</option></select>
                                <button class="toolbar-button-circle toolbar-button" data-bs-toggle="tooltip" data-placement="top" title=@Localizer["DeckSettings"] @@click="openSettingsPage()"><i class="fas fa-pen"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="The card" class="card learning-card" v-if="currentCard">
                <div id="Small buttons" class="card-header" style="padding:1px">
                    <ul class="small-buttons-ul">
                        <li id="Edit button" style="padding-right:5px">
                            <van-button class="toolbar-button-circle toolbar-button" title=@Localizer["Edit"] @@click="editCard"><i class="fas fa-pen"></i></van-button>
                        </li>
                        <li id="Remove button" style="padding-right:5px">
                            <van-button class="toolbar-button-circle toolbar-button" title=@Localizer["RemoveFromDeck"] @@click="removeCard"><i class="fas fa-trash-alt"></i></van-button>
                        </li>
                        <li id="Info button" style="padding-right:5px" title=@Localizer["Info"]>
                            <van-popover v-model:show="showInfoPopover" overlay close-on-click-outside close-on-click-overlay>
                                @Localizer["LastLearnDate"] {{dateTime(currentCard.lastLearnUtcTime)}}
                                <hr class="menu-separation-line" />
                                @Localizer["DateAddedInDeck"] {{dateTime(currentCard.addToDeckUtcTime)}}
                                <hr class="menu-separation-line" />
                                <div class="popover-section-title">@Localizer["CardVersion"]</div><br />
                                @Localizer["CreatedBy"] {{currentCard.owner}}<br />
                                @Localizer["OnDate"] {{dateTime(currentCard.lastChangeUtcTime)}}
                                <hr class="menu-separation-line" />
                                <a v-if="currentCard.registeredForNotifications" href="nothin" @@click.prevent="unregisterForNotif()">@Localizer["RegisteredForNotif"]</a><a v-else href="nothin" @@click.prevent="registerForNotif()">@Localizer["NotRegisteredForNotif"]</a>
                                <template #reference>
                                    <van-button class="toolbar-button-circle toolbar-button"><i class="fas fa-info"></i></van-button>
                                </template>
                            </van-popover>
                        </li>
                        <li id="Visibility button" style="padding-right:5px" title=@Localizer["Visibility"]>
                            <van-popover v-model:show="showVisibilityPopover" overlay close-on-click-outside close-on-click-overlay>
                                @Localizer["Visibility"]: {{currentCard.visibleTo}}
                                <template #reference>
                                    <van-button class="toolbar-button-circle toolbar-button" v-if="currentCard.visibleToCount == 0"><i class="far fa-eye"></i></van-button>
                                    <van-button class="toolbar-button-circle toolbar-button" v-if="currentCard.visibleToCount == 1"><i class="far fa-eye-slash"></i></van-button>
                                    <van-button class="toolbar-button-circle toolbar-button" v-if="currentCard.visibleToCount > 1"><i class="fas fa-users"></i></van-button>
                                </template>
                            </van-popover>
                        </li>
                        <li id="FilteringButton" style="padding-right:5px">
                            <van-button class="toolbar-button toolbar-button-circle" title=@Localizer["FilterThisLearningSession"] @@click="switchToFilteringMode()"><i class="fas fa-ellipsis-v"></i></van-button>
                        </li>
                        <li id="Heap info" style="padding-right:5px" title=@Localizer["Heap"]>
                            <van-popover v-model:show="heapInfoPopover" overlay close-on-click-outside close-on-click-overlay>
                                @Localizer["CurrentlyInHeap"] {{currentCard.heap}}<br />
                                @Localizer["TimesInNotLearnedHeap"] {{currentCard.nbTimesInNotLearnedHeap}}<br />
                                @Localizer["BiggestHeapReached"] {{currentCard.biggestHeapReached}}
                                <hr class="menu-separation-line" />
                                <van-popover v-model:show="showMoveToHeapMenuPopover" overlay close-on-click-outside close-on-click-overlay>
                                    <van-button class="toolbar-button dropdown-item" v-for="targetHeap in currentCard.moveToHeapTargets" @@click="moveToHeap(targetHeap)">
                                        <span v-if="targetHeap.heapId < currentCard.heapId"><i class="fas fa-angle-left"></i></span><span v-else><i class="fas fa-angle-right"></i></span>
                                        {{targetHeap.heapName}}
                                    </van-button>
                                    <template #reference>
                                        <van-button class="toolbar-button">@Localizer["MoveToHeap"]</van-button>
                                    </template>
                                </van-popover>
                                <template #reference>
                                    <van-button class="toolbar-button"><i class="fas fa-layer-group"></i> {{currentCard.heap}}</van-button>
                                </template>
                            </van-popover>
                        </li>
                        <li id="Rating">
                            <card-rating v-model="currentCard.currentUserRating" v-bind:average="currentCard.averageRating" v-bind:countinaverage="currentCard.countOfUserRatings" v-on:update:model-value="onRatingChange"
                                         yourratingstr='@Localizer["YourRating"]' averagestr='@Localizer["Average"]' usersstr='@Localizer["Users"]' userstr='@Localizer["User"]' />
                        </li>
                        <li id="Last learn date" v-if="!learningUnknowns" class="ms-auto" data-bs-toggle="tooltip" data-placement="top" v-bind:title="'@Localizer["LastLearnDate"] ' + dateTimeWithTime(currentCard.lastLearnUtcTime)">
                            <i class="fas fa-clock"></i> {{dateTime(currentCard.lastLearnUtcTime)}}
                        </li>
                    </ul>
                </div>
                <div id="Front side" class="learning-card">
                    <div class="card" v-if="currentCard">
                        <div class="card-header learning-card-header">
                            <p>@Localizer["FrontSide"]</p>
                        </div>
                        <div class="markdown-render markdown-body">
                            <span v-html="currentCardFrontSide()"></span>
                        </div>
                        <div class="learning-card-body-image-div" v-for="image in currentCard.images">
                            <a href="#" @@click="showImageFull(image)" v-if="image.cardSide==1"><img class="imageincard" :src="image.blob" /></a>
                        </div>
                        <div v-if="!backSideVisible" class="card-footer learning-card-footer">
                            <button class="btn btn-success btn-md" @@click="showBackSide">@Localizer["ShowBack"]</button>
                        </div>
                    </div>
                </div>
                <div id="Back side" v-if="backSideVisible" class="learning-card">
                    <div class="card" v-if="currentCard">
                        <div class="card-header learning-card-header">
                            <p>@Localizer["BackSide"]</p>
                        </div>
                        <div class="markdown-render markdown-body">
                            <span v-html="currentCardBackSide()"></span>
                        </div>
                        <div class="learning-card-body-image-div" v-for="image in currentCard.images">
                            <a href="#" @@click="showImageFull(image)" v-if="image.cardSide==2"><img class="imageincard" :src="image.blob" /></a>
                        </div>
                    </div>
                </div>
                <div id="Knew Forgot" v-if="backSideVisible" class="card-footer learning-card-footer">
                    <ul class="nav small">
                        <li><button class="btn btn-success btn-md" @@click="knew">@Localizer["Knew"]</button></li>
                        <li class="ms-auto"><button class="btn btn-danger btn-md" @@click="forgot"><span v-if="learningUnknowns">@Localizer["DidNotKnow"]</span><span v-else>@Localizer["Forgot"]</span></button></li>
                    </ul>
                </div>
                <div id="Additional info" v-if="backSideVisible && currentCardHasAdditionalSide()" class="learning-card">
                    <div class="card" v-if="currentCard">
                        <div class="card-header learning-card-header">
                            <p>@Localizer["AdditionalInfo"]</p>
                        </div>
                        <div class="markdown-render markdown-body">
                            <span v-html="currentCardAdditionalInfo()"></span>
                        </div>
                        <div class="learning-card-body-image-div" v-for="image in currentCard.images">
                            <a href="#" @@click="showImageFull(image)" v-if="image.cardSide==3"><img class="imageincard" :src="image.blob" /></a>
                        </div>
                    </div>
                </div>
                <div id="Tags" v-if="currentCard.tags.length > 0" class="card-footer learning-card-tags">
                    <tag-button v-for="tag in currentCard.tags" v-bind:name="tag"></tag-button>
                </div>
            </div>
            <div id="No more card" class="card border-primary" v-if="!currentCard">
                <p class="wait-message" v-if="currentImageLoadingPromise">@Localizer["PleaseWaitForImageLoad"]</p>
                <div v-else>
                    <p class="wait-message" v-if="preventQuittingPage()">@Localizer["PleaseWaitSavingData"]</p>
                    <div v-else>
                        <p class="wait-message">@Localizer["NoMoreCardTo"] <span v-if="learningUnknowns">@Localizer["Learn"]</span><span v-else>@Localizer["Repeat"]</span></p>
                        <a href="/" class="wait-message">@Localizer["BackToHomePage"]</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="UserQuitAttemptDisplayMode" v-if="userQuitAttemptDisplay">
        <p>@Localizer["ExplainMoveOperationsBeforeIcon"] <i class="fas fa-save"></i> @Localizer["ExplainMoveOperationsAfterIcon"]</p>
        <button class="btn btn-success toolbar-button" @@click="userQuitAttemptDisplay = false">@Localizer["ExplainMoveOperationsOkButton"]</button>
    </div>
    <div id="Processing info">
        <p v-if="preventQuittingPage()"><i class="fas fa-save"></i></p>
    </div>
    <div id="DebugInfo" class="debug-info-div collapse" v-if="showDebugInfo()">
        <ul>
            <li v-if="!downloadedCards">downloadedCards is null</li>
            <li v-if="downloadedCards">downloadedCards.length: {{downloadedCards.length}}</li>
            <li>lastDownloadIsEmpty: {{lastDownloadIsEmpty}}</li>
            <li v-if="!cardDownloadOperation">No cardDownloadOperation</li>
            <li v-if="cardDownloadOperation">cardDownloadOperation: {{cardDownloadOperation}}</li>
            <li v-if="!currentCard">No currentCard</li>
            <li v-if="currentCard">currentCard.visibleToCount: {{currentCard.visibleToCount}}</li>
            <li v-if="currentCard">currentCard.heapId: {{currentCard.heapId}}</li>
            <li v-if="currentCard">currentCard.Last learn time: {{dateTimeWithTime(currentCard.lastLearnUtcTime)}}</li>
            <li>pendingMoveOperations.length: {{pendingMoveOperations.length}}</li>
            <li v-if="!currentMovePromise">currentMovePromise is null</li>
            <li v-if="currentMovePromise">currentMovePromise: {{currentMovePromise}}</li>
            <li v-if="additionalMoveDebugInfo">Move info: {{additionalMoveDebugInfo}}</li>
            <li v-if="!currentImageLoadingPromise">currentImageLoadingPromise is null</li>
            <li v-if="currentImageLoadingPromise">currentImageLoadingPromise: {{currentImageLoadingPromise}}</li>
            <li>pendingRatingOperations.length: {{pendingRatingOperations.length}}</li>
            <li v-if="!currentRatingPromise">currentRatingPromise is null</li>
            <li v-if="currentRatingPromise">currentRatingPromise: {{currentRatingPromise}}</li>
            <li v-if="additionalRatingDebugInfo">Rating info: {{additionalRatingDebugInfo}}</li>
        </ul>
    </div>
</div>
